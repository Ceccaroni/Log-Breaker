<script>
    // =================================================================
    // TEIL 1: DIE LERN-MODULE (1-8) - UNVERÄNDERT
    // (Damit die oberen Kacheln funktionieren)
    // =================================================================

    // REGEL 1: Rucksack
    function activateMod1() {
        const t = document.getElementById('trigger1');
        t.style.transform = "translate(-180px, 0px)"; t.style.color = "var(--c-action)"; t.style.borderColor = "transparent"; t.style.background = "transparent"; t.style.zIndex = "100";
        setTimeout(() => { document.querySelector('#mod1 .equation-stage').innerHTML = `<span class="atom success-text" style="font-size: 2.2rem; margin-right: 10px;">2 •</span><span class="atom log-box">log<span class="base">a</span></span><span class="atom">(</span><span class="atom cargo">x</span><span class="atom">)</span>`; }, 300);
    }
    function resetMod1() {
        document.querySelector('#mod1 .equation-stage').innerHTML = `<span class="atom log-box">log<span class="base">a</span></span><span class="atom">(</span><span class="atom cargo">x</span><span class="atom trigger" id="trigger1" onclick="activateMod1()" style="vertical-align: super; font-size: 1.4rem; margin-left:-5px;">2</span><span class="atom">)</span>`;
    }

    // REGEL 2: Produkt
    function activateMod2() {
        document.querySelector('#mod2 .equation-stage').innerHTML = `<span class="atom log-box">log<span class="base">a</span></span><span class="atom cargo">(x)</span><span class="atom success-text" style="font-size:3rem; margin:0 15px; animation:popIn 0.5s;">+</span><span class="atom log-box" style="animation:popIn 0.5s;">log<span class="base">a</span></span><span class="atom cargo">(y)</span>`;
    }
    function resetMod2() {
        document.querySelector('#mod2 .equation-stage').innerHTML = `<span class="atom log-box">log<span class="base">a</span></span><span class="atom">(</span><span class="atom cargo">x</span><span class="atom trigger" id="trigger2" onclick="activateMod2()" style="margin: 0 5px;">•</span><span class="atom cargo">y</span><span class="atom">)</span>`;
    }

    // REGEL 3: Bruch
    function activateMod3() {
        document.querySelector('#mod3 .equation-stage').innerHTML = `<span class="atom log-box">log<span class="base">a</span></span><span class="atom cargo">(x)</span><span class="atom success-text" style="font-size:3rem; margin:0 15px; animation:popIn 0.5s;">-</span><span class="atom log-box" style="animation:popIn 0.5s;">log<span class="base">a</span></span><span class="atom cargo">(y)</span>`;
    }
    function resetMod3() {
        document.querySelector('#mod3 .equation-stage').innerHTML = `<span class="atom log-box">log<span class="base">a</span></span><div style="display:inline-flex; flex-direction:column; align-items:center; margin: 0 10px; vertical-align:middle;"><span class="atom cargo">x</span><span class="atom trigger" id="trigger3" onclick="activateMod3()" style="width: 40px; height: 4px; border:none; background:var(--c-danger); margin: 2px 0;"></span><span class="atom cargo" id="y-val">y</span></div>`;
    }

    // REGEL 4: Zwillinge
    function activateMod4() {
        const logPart = document.getElementById('log2-atom');
        const trigger = document.getElementById('base-match-trigger');
        const x = document.getElementById('power-x');
        logPart.classList.add('vanish'); trigger.classList.add('vanish');
        setTimeout(() => { x.style.transform = "translate(-60px, 30px) scale(2)"; x.style.color = "var(--c-action)"; x.style.verticalAlign = "middle"; x.innerText = "x"; }, 200);
    }
    function resetMod4() {
        const logPart = document.getElementById('log2-atom'); const trigger = document.getElementById('base-match-trigger'); const x = document.getElementById('power-x');
        logPart.classList.remove('vanish'); trigger.classList.remove('vanish');
        x.style = "vertical-align: super; font-size: 1.4rem;"; x.innerText = "x"; x.style.color = "var(--c-cargo)";
    }

    // REGEL 5: Todfeinde
    function activateMod5() { 
        document.getElementById('ln-atom').classList.add('vanish');
        document.getElementById('e-atom').classList.add('vanish');
        setTimeout(() => { 
            const x = document.getElementById('ln-x');
            x.style.transform = "translate(-40px, 30px) scale(2)"; x.style.color = "var(--c-action)"; x.style.verticalAlign = "middle"; 
        }, 200);
    }
    function resetMod5() {
        document.querySelector('#mod5 .equation-stage').innerHTML = `<span class="atom trigger" id="ln-atom" onclick="activateMod5()">ln</span><span class="atom">(</span><span class="atom base" id="e-atom" style="font-size: 1.8rem;">e</span><span class="atom cargo" id="ln-x" style="vertical-align: super; font-size: 1.4rem;">x</span><span class="atom">)</span>`;
    }

    // REGEL 6: Log 1
    function activateMod6() { document.getElementById('stage6').innerHTML = `<span style="font-size:4rem; color:var(--c-action); animation:popIn 0.5s;">0</span>`; }
    function resetMod6() { document.querySelector('#mod6 .equation-stage').innerHTML = `<span class="atom log-box">log<span class="base">10</span></span><span class="atom">(</span><span class="atom trigger" id="one-trigger" onclick="activateMod6()">1</span><span class="atom">)</span>`; }

    // REGEL 7: Turm
    function activateMod7() {
        document.getElementById('tower-base').classList.add('vanish');
        document.getElementById('tower-log').classList.add('vanish');
        setTimeout(() => {
            const x = document.getElementById('tower-x');
            x.style.transform = "translate(-30px, 30px) scale(2)"; x.style.color = "var(--c-action)"; x.innerText = "x";
        }, 300);
    }
    function resetMod7() {
        document.querySelector('#mod7 .equation-stage').innerHTML = `<div style="display:flex; align-items:flex-start;"><span class="atom base" id="tower-base" style="font-size: 3rem; margin-top: 20px; margin-right:5px;">a</span><div style="display:flex; align-items:center; margin-bottom: 20px;"><span class="atom trigger" id="tower-log" onclick="activateMod7()" style="font-size: 1.5rem;">log<sub style="color:var(--c-base)">a</sub></span><span class="atom cargo" id="tower-x" style="font-size: 1.5rem; margin-left:2px;">(x)</span></div></div>`;
    }

    // REGEL 8: Wurzel
    function activateMod8() {
        document.getElementById('root-stage').innerHTML = `<span class="atom log-box">log</span><span class="atom">(</span><span class="atom cargo">x</span><span class="atom success-text" style="vertical-align: super; font-size: 1.4rem; animation:popIn 0.5s;">1/2</span><span class="atom">)</span>`;
    }
    function resetMod8() {
        document.getElementById('root-stage').innerHTML = `<span class="atom log-box">log</span><span class="atom">(</span><span class="atom trigger" id="root-symbol" onclick="activateMod8()" style="font-size: 2.5rem; margin-right:-10px;">√</span><span class="atom cargo" style="border-top: 2px solid var(--c-danger); padding-top:5px;">x</span><span class="atom">)</span>`;
    }


    // =================================================================
    // TEIL 2: DIE NEUE, ROBUSTE SANDBOX ENGINE
    // =================================================================
    
    function setInput(val) {
        document.getElementById('custom-input').value = val;
    }

    function clearSandbox() {
        document.getElementById('custom-input').value = "";
        document.getElementById('sandbox-stage').innerHTML = `<span style="color:#A0AEC0;">Warte auf Eingabe...</span>`;
        document.getElementById('sandbox-text').innerText = "Tippe oben eine Aufgabe ein.";
    }

    // Start-Punkt: Wird vom Button aufgerufen
    function parseInput() {
        let raw = document.getElementById('custom-input').value;
        if(!raw) return;

        // 1. REINIGUNG: Wir machen den Input computer-freundlich
        raw = raw.replace(/\s/g, ''); // Leerzeichen weg
        raw = raw.replace(/log_[a-z0-9]+/g, 'log'); // Basis ignorieren
        raw = raw.replace(/wurzel/g, 'sqrt'); // Deutsch zu Englisch
        
        // Wir starten die Analyse
        renderExpression(raw);
    }

    // Diese Funktion entscheidet, was angezeigt wird
    function renderExpression(expr) {
        const stage = document.getElementById('sandbox-stage');
        const info = document.getElementById('sandbox-text');

        // --- SCHUTZ VOR LEEREN EINGABEN ---
        if (!expr) return;

        // --- CHECK 1: DER TURM (Basis^log...) ---
        // Erkennt: a^(log(...)) oder a^log(...)
        if (expr.includes('^') && (expr.includes('log') || expr.includes('ln'))) {
            // Wir prüfen, ob das log direkt nach dem ^ kommt (oder in Klammern danach)
            const parts = expr.split('^');
            const base = parts[0];
            let exponent = parts.slice(1).join('^'); // Alles nach dem ersten ^
            
            // Wenn der Exponent mit log beginnt (oder (log...) )
            if (exponent.includes('log') || exponent.includes('ln')) {
                // Wir nehmen an, es ist ein Turm.
                // Exponent säubern: Äußere Klammern entfernen, falls vorhanden: (log(x)) -> log(x)
                if(exponent.startsWith('(') && exponent.endsWith(')')) {
                    exponent = exponent.slice(1, -1);
                }

                stage.innerHTML = `
                    <div style="display:flex; align-items:flex-start;">
                        <span class="atom base" style="font-size: 3rem; margin-top: 20px;">${base}</span>
                        <div style="border: 2px dashed var(--c-danger); padding:10px; border-radius:10px; background:rgba(229,62,62,0.05); margin-left:5px;">
                            <div style="font-size:0.7rem; color:var(--c-danger); margin-bottom:5px; font-weight:bold;">DACHGESCHOSS</div>
                            <div id="exponent-ui" style="display:flex; align-items:center;">
                                <span class="atom trigger" onclick="solveTower('${exponent}')" style="font-size: 1.2rem;">${exponent}</span>
                            </div>
                        </div>
                    </div>
                `;
                info.innerHTML = "<strong>Der Turm!</strong> (Regel 7).<br>Klicke auf den Exponenten (Dachgeschoss), um ihn zu prüfen.";
                return;
            }
        }

        // --- CHECK 2: WURZEL (sqrt) ---
        if (expr.includes('sqrt')) {
            // Finde was in der Wurzel steht: sqrt( ... )
            const content = getInnerContent(expr, 'sqrt');
            
            stage.innerHTML = `
                <span class="atom log-box">log</span>
                <span class="atom">(</span>
                <span class="atom trigger" onclick="transformSqrt('${content}')" style="font-size: 2.5rem; margin-right:-5px;">√</span>
                <span class="atom cargo" style="border-top: 2px solid var(--c-danger); padding-top:5px;">${content}</span>
                <span class="atom">)</span>
            `;
            info.innerHTML = "Eine <strong>Wurzel</strong>! Klick sie weg.";
            return;
        }

        // --- CHECK 3: BRUCH / GETEILT ---
        // Wir suchen ein / das NICHT in inneren Klammern steckt
        const splitIndex = findSplitIndex(expr, '/');
        if (splitIndex !== -1) {
            const num = expr.substring(0, splitIndex);
            const den = expr.substring(splitIndex + 1);
            
            // Log-Wrapper entfernen falls vorhanden: log(A/B) -> A und B
            const cleanNum = stripLogWrapper(num);
            const cleanDen = stripLogWrapper(den);

            stage.innerHTML = `
                <span class="atom log-box">log</span>
                <div style="display:inline-flex; flex-direction:column; align-items:center; margin: 0 10px; vertical-align:middle;">
                    <span class="atom cargo">${cleanNum}</span>
                    <span class="atom trigger" onclick="transformDivide('${cleanNum}', '${cleanDen}')" style="width: 100%; height: 4px; border:none; background:var(--c-danger); margin: 2px 0;"></span>
                    <span class="atom cargo">${cleanDen}</span>
                </div>
            `;
            info.innerHTML = "Ein <strong>Bruch</strong>! Klick auf den Strich.";
            return;
        }

        // --- CHECK 4: MAL (PRODUKT) ---
        const multIndex = findSplitIndex(expr, '*');
        if (multIndex !== -1) {
            const partA = expr.substring(0, multIndex);
            const partB = expr.substring(multIndex + 1);
            
            const cleanA = stripLogWrapper(partA);
            const cleanB = stripLogWrapper(partB);

            stage.innerHTML = `
                <span class="atom log-box">log</span>(
                <span class="atom cargo">${cleanA}</span>
                <span class="atom trigger" onclick="transformMultiply('${cleanA}', '${cleanB}')" style="margin:0 5px;">•</span>
                <span class="atom cargo">${cleanB}</span>
                )
            `;
            info.innerHTML = "Ein <strong>Produkt</strong> (*). Klick auf den Punkt.";
            return;
        }

        // --- CHECK 5: SUMME (+) ---
        // Falls der User schon log(a) + log(b) eingegeben hat
        const plusIndex = findSplitIndex(expr, '+');
        if (plusIndex !== -1) {
            const partA = expr.substring(0, plusIndex);
            const partB = expr.substring(plusIndex + 1);

            stage.innerHTML = `
                <span class="atom">${partA}</span>
                <span class="atom trigger" onclick="transformSum('${partA}', '${partB}')" style="font-size:2rem; color:var(--c-danger); margin:0 10px;">+</span>
                <span class="atom">${partB}</span>
            `;
            info.innerHTML = "Eine <strong>Summe</strong>. Klick auf Plus zum Zusammenfassen (oder lass es so, wenn du fertig bist).";
            return;
        }

        // --- CHECK 6: POTENZ / RUCKSACK (^) ---
        // log(x^2)
        const powIndex = findSplitIndex(expr, '^');
        if (powIndex !== -1) {
            let base = expr.substring(0, powIndex);
            let exp = expr.substring(powIndex + 1);
            
            base = stripLogWrapper(base); // log(x) -> x

            stage.innerHTML = `
                <span class="atom log-box">log</span>(
                <span class="atom cargo">${base}</span>
                <span class="atom trigger" id="sand-exp" onclick="transformPower('${base}', '${exp}')" style="vertical-align: super; font-size: 1.2rem;">${exp}</span>
                )
            `;
            info.innerHTML = "Ein <strong>Rucksack</strong> (Exponent). Klick ihn an!";
            return;
        }
        
        // --- CHECK 7: RUCKSACK VORNE (2*log) ---
        if (expr.includes('*log') || expr.includes('*ln')) {
            const parts = expr.split('*');
            // Einfacher Check: Nimm alles vor dem letzten * als Faktor
            // (Nicht perfekt, aber reicht für 2*log(x))
            const factor = parts[0];
            const rest = parts.slice(1).join('*');
            const content = extractInner(rest);

            stage.innerHTML = `
                <span class="atom trigger" onclick="transformFactor('${factor}', '${content}')" style="font-size: 1.5rem; color:var(--c-danger); margin-right:5px; vertical-align:middle;">${factor} •</span>
                <span class="atom log-box">log</span>(<span class="atom cargo">${content}</span>)
            `;
            info.innerHTML = "Ein Faktor davor. Klick ihn an!";
            return;
        }

        // FALLBACK (Nichts erkannt)
        stage.innerHTML = `<span style="font-family:monospace; font-size:1.5rem;">${expr}</span>`;
        info.innerHTML = "Konnte keine Regel anwenden. Versuch, Klammern zu setzen!<br>Beispiel: <code>log((a*b)/c)</code>";
    }


    // --- HILFSFUNKTIONEN (DAS GEHIRN) ---

    // Findet das Trennzeichen (+, *, /), ignoriert aber alles in Klammern!
    function findSplitIndex(str, char) {
        let depth = 0;
        // Wir suchen von rechts nach links, um "log(x^2 * y / z)" richtig zu teilen (erst / dann *)
        // ABER: Für "log(A * B)" suchen wir in der Klammer.
        // Trick: Wir entfernen erst das äußere "log(" und ")", falls vorhanden.
        let core = stripLogWrapper(str);
        if (core === str) { 
            // Kein log() drumrum? Dann suchen wir im ganzen String
        } else {
            // Log drumrum? Wir suchen nur im Inhalt!
            // Aber Achtung: Der Index muss sich auf den Inhalt beziehen.
        }

        // Simplerer Ansatz für Dyskalkulie-Tool: 
        // Wir scannen einfach den String. Wenn wir in einer Klammer sind, ignorieren wir Zeichen.
        // Wenn wir "log(...)" haben, ignorieren wir das log NICHT, wir wollen ja den Inhalt scannen.
        
        // Wir scannen NUR den Inhalt von log(...) wenn es damit anfängt
        let scanStr = str;
        let offset = 0;
        if (str.startsWith('log(') && str.endsWith(')')) {
            scanStr = str.slice(4, -1);
            offset = 4;
        } else if (str.startsWith('ln(') && str.endsWith(')')) {
            scanStr = str.slice(3, -1);
            offset = 3;
        }

        for (let i = 0; i < scanStr.length; i++) {
            if (scanStr[i] === '(') depth++;
            else if (scanStr[i] === ')') depth--;
            else if (depth === 0 && scanStr[i] === char) {
                return i + offset;
            }
        }
        return -1;
    }

    function stripLogWrapper(str) {
        if (str.startsWith('log(') && str.endsWith(')')) return str.slice(4, -1);
        if (str.startsWith('ln(') && str.endsWith(')')) return str.slice(3, -1);
        return str;
    }

    function extractInner(str) {
        // Holt Text aus log(...)
        if (str.includes('(')) {
            let start = str.indexOf('(');
            let end = str.lastIndexOf(')');
            return str.substring(start+1, end);
        }
        return str;
    }

    function getInnerContent(str, funcName) {
        // Holt Inhalt aus funcName(...)
        let start = str.indexOf(funcName) + funcName.length + 1; // +1 für (
        // Finde passendes End-Klammer
        let depth = 1;
        let end = start;
        while (depth > 0 && end < str.length) {
            if (str[end] === '(') depth++;
            if (str[end] === ')') depth--;
            end++;
        }
        return str.substring(start, end-1);
    }

    // --- TRANSFORMATIONS (WAS PASSIERT BEIM KLICK) ---
    // Der Trick: Statt nur Text zu zeigen, rufen wir eine Funktion auf, 
    // die Knöpfe rendert, um WEITER zu machen!

    function transformDivide(num, den) {
        const stage = document.getElementById('sandbox-stage');
        const info = document.getElementById('sandbox-text');
        
        stage.innerHTML = `
            <div style="text-align:center;">
                <div style="margin-bottom:15px; font-size:1.8rem;">
                    <span class="atom log-box">log</span>(${num}) 
                    <span class="success-text">-</span> 
                    <span class="atom log-box">log</span>(${den})
                </div>
                <div style="display:flex; gap:10px; justify-content:center;">
                    <button class="action-btn" onclick="continueWith('log(${num})')">Linken Teil weiter?</button>
                    <button class="action-btn" onclick="continueWith('log(${den})')">Rechten Teil weiter?</button>
                </div>
            </div>
        `;
        info.innerHTML = "Bruch zerlegt! Wähle einen Teil aus, um dort weiterzumachen.";
    }

    function transformMultiply(a, b) {
        const stage = document.getElementById('sandbox-stage');
        const info = document.getElementById('sandbox-text');
        
        stage.innerHTML = `
            <div style="text-align:center;">
                <div style="margin-bottom:15px; font-size:1.8rem;">
                    <span class="atom log-box">log</span>(${a}) 
                    <span class="success-text">+</span> 
                    <span class="atom log-box">log</span>(${b})
                </div>
                <div style="display:flex; gap:10px; justify-content:center;">
                    <button class="action-btn" onclick="continueWith('log(${a})')">Linken Teil weiter?</button>
                    <button class="action-btn" onclick="continueWith('log(${b})')">Rechten Teil weiter?</button>
                </div>
            </div>
        `;
        info.innerHTML = "Produkt zerlegt! Wähle einen Teil aus.";
    }

    function transformPower(base, exp) {
        const stage = document.getElementById('sandbox-stage');
        const info = document.getElementById('sandbox-text');
        
        // Animation
        const t = document.getElementById('sand-exp');
        if(t) {
             t.style.transform = "translate(-100px, 0px)"; 
             t.style.color = "var(--c-action)";
        }

        setTimeout(() => {
            stage.innerHTML = `
                <div style="text-align:center;">
                    <div style="margin-bottom:15px; font-size:1.8rem;">
                        <span class="success-text">${exp} • </span>
                        <span class="atom log-box">log</span>(${base})
                    </div>
                    <button class="action-btn" onclick="continueWith('log(${base})')">Den Rest zerlegen?</button>
                </div>
            `;
            info.innerHTML = "Rucksack unten! Willst du den Rest noch knacken?";
        }, 300);
    }

    function transformSqrt(content) {
        const stage = document.getElementById('sandbox-stage');
        stage.innerHTML = `
             <div style="text-align:center;">
                <div style="margin-bottom:15px; font-size:1.8rem;">
                    <span class="atom log-box">log</span>(
                    <span class="atom cargo">${content}</span>
                    <span class="success-text" style="vertical-align:super; font-size:1rem;">1/2</span>
                    )
                </div>
                <button class="action-btn" onclick="continueWith('log(${content}^(1/2))')">Jetzt Rucksack werfen!</button>
            </div>
        `;
        document.getElementById('sandbox-text').innerHTML = "Wurzel ist jetzt Hoch 1/2. Klick den Button, um weiterzumachen!";
    }

    function transformFactor(factor, content) {
        const stage = document.getElementById('sandbox-stage');
        stage.innerHTML = `
             <div style="text-align:center;">
                <div style="margin-bottom:15px; font-size:1.8rem;">
                    <span class="atom log-box">log</span>(
                    <span class="atom cargo">${content}</span>
                    <span class="success-text" style="vertical-align:super; font-size:1rem;">${factor}</span>
                    )
                </div>
                <div style="color:var(--c-action);">Der Faktor ist jetzt wieder ein Exponent!</div>
            </div>
        `;
    }

    function transformSum(a, b) {
        // log(a) + log(b) -> log(a*b)
        // a und b sind strings wie "log(x)"
        const innerA = extractInner(a);
        const innerB = extractInner(b);
        
        const stage = document.getElementById('sandbox-stage');
        stage.innerHTML = `
            <div style="font-size:1.8rem; color:var(--c-action);">
                <span class="atom log-box">log</span>(${innerA} • ${innerB})
            </div>
        `;
        document.getElementById('sandbox-text').innerHTML = "Zusammengefasst!";
    }

    function solveTower(exponent) {
        // Wenn man beim Turm auf den Exponenten klickt
        const stage = document.getElementById('sandbox-stage');
        
        // Prüfen ob der Exponent noch "schmutzig" ist (Rechenzeichen enthält)
        if (exponent.includes('+') || exponent.includes('-') || exponent.includes('/')) {
            // Noch nicht fertig
             stage.innerHTML = `
                <div style="color:var(--c-danger); font-size:1.5rem; text-align:center;">
                    Halt! Das Dachgeschoss ist unordentlich!<br>
                    <code>${exponent}</code><br>
                    Räum das erst auf (Tipp es oben ein), bis nur noch <b>log(...)</b> da steht.
                </div>
            `;
        } else {
            // Wir nehmen an es ist sauber log(...)
            let content = extractInner(exponent);
            stage.innerHTML = `
                <div style="font-size:3rem; color:var(--c-action); animation:popIn 0.5s;">
                    ${content}
                </div>
            `;
            document.getElementById('sandbox-text').innerHTML = "<strong>Zack!</strong> Basis und Log weg. Das Ergebnis ist gelandet.";
        }
    }

    // Die Magie: Das neue Input setzen und sofort parsen
    function continueWith(newExpr) {
        document.getElementById('custom-input').value = newExpr;
        parseInput();
    }

    // CSS Inject
    const styleSheet = document.createElement("style");
    styleSheet.innerText = `
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 80% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); } }
    `;
    document.head.appendChild(styleSheet);

</script>
