<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log-Breaker: PLATINUM EDITION (Fixed) üíé</title>
    <style>
        /* --- DESIGN SYSTEM --- */
        :root {
            --c-base: #0055AA;      /* BLAU */
            --c-container: #718096; /* GRAU */
            --c-cargo: #ED8936;     /* ORANGE */
            --c-danger: #E53E3E;    /* ROT */
            --c-action: #48BB78;    /* GR√úN */
            --bg: #F7FAFC;
        }

        body {
            font-family: 'Verdana', sans-serif;
            background: var(--bg);
            color: #2D3748;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 { text-align: center; margin-bottom: 5px; color: #2D3748; }
        p.sub { text-align: center; color: #718096; max-width: 600px; margin-bottom: 40px; line-height: 1.5; }

        .module {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            width: 100%;
            max-width: 700px;
            margin-bottom: 30px;
            padding: 25px;
            position: relative;
            border-left: 10px solid var(--c-container);
            transition: transform 0.2s;
        }
        
        .module:hover { transform: translateY(-2px); }

        .module-header {
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #A0AEC0;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }

        .equation-stage {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.2rem; 
            font-weight: bold;
            font-family: 'Courier New', monospace; 
            height: 140px;
            background: #EDF2F7;
            border-radius: 12px;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
            user-select: none;
            /* MOBILE FIX: Wrap erlauben, falls es eng wird */
            flex-wrap: wrap;
            align-content: center;
        }

        .atom {
            display: inline-block;
            padding: 2px 5px;
            transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            z-index: 1;
        }

        .log-box { color: var(--c-container); }
        .base { font-size: 1rem; color: var(--c-base); vertical-align: sub; font-weight: bold;}
        .cargo { color: var(--c-cargo); }
        
        .trigger {
            color: var(--c-danger);
            cursor: pointer;
            border: 2px dashed var(--c-danger);
            border-radius: 8px;
            /* APPLE TOUCH TARGET FIX: Gr√∂√üeres Padding f√ºr Finger */
            padding: 5px 10px; 
            margin: 0 2px;
            background: rgba(229, 62, 62, 0.05);
            animation: pulse 2.5s infinite;
            /* Verhindert Zoom beim Doppeltippen auf Mobile */
            touch-action: manipulation; 
        }
        
        .trigger:hover {
            background: var(--c-danger);
            color: white;
            transform: scale(1.1);
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(229, 62, 62, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(229, 62, 62, 0); }
            100% { box-shadow: 0 0 0 0 rgba(229, 62, 62, 0); }
        }

        .reset-btn {
            background: transparent;
            border: 1px solid #CBD5E0;
            color: #718096;
            padding: 8px 16px; /* Gr√∂√üer f√ºr Mobile */
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.7rem;
            text-transform: uppercase;
        }
        .reset-btn:hover { background: #E2E8F0; color: #2D3748; }

        .explanation {
            background: #fff;
            color: #4A5568;
            font-size: 0.95rem;
            line-height: 1.6;
            padding-top: 10px;
            border-top: 1px solid #EDF2F7;
        }
        
        strong { color: var(--c-base); }

        /* Helpers */
        .vanish { opacity: 0 !important; transform: scale(0) !important; filter: blur(10px); }
        .success-text { color: var(--c-action) !important; border-color: transparent !important; background: transparent !important; }

        /* SANDBOX STYLES */
        #sandbox {
            border-left: 10px solid #805AD5; 
            border: 2px solid #805AD5;
            background: #fff;
        }
        #sandbox .module-header { color: #805AD5; }
        
        #sandbox .equation-stage {
            height: auto !important; 
            min-height: 160px;
            padding: 30px;
            overflow: visible;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            width: 100%;
            flex-direction: column; /* Mobile first: untereinander */
        }
        @media(min-width: 500px) {
            .input-group { flex-direction: row; } /* Desktop: nebeneinander */
        }

        input#custom-input {
            width: 100%;
            padding: 15px; /* Dicker f√ºr Finger */
            font-size: 1.1rem;
            font-family: 'Courier New', monospace;
            border: 2px solid #E2E8F0;
            border-radius: 8px;
            outline: none;
        }
        input#custom-input:focus { border-color: #805AD5; }

        button.action-btn {
            background: #805AD5;
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            white-space: nowrap;
        }
        button.action-btn:hover { background: #6B46C1; }

        .helper-chips {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .chip {
            background: #EDF2F7;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .chip:hover { border-color: #805AD5; background: #E9D8FD; }

    </style>
</head>
<body>

    <h1>Log-Breaker PLATINUM üíé</h1>
    <p class="sub">Jetzt mit allen Regeln und Mobile-Support.</p>

    <div class="module" id="mod1">
        <div class="module-header">
            <span>REGEL 1: Der Rucksack (Potenzgesetz)</span>
            <button class="reset-btn" onclick="resetMod1()">Nochmal</button>
        </div>
        <div class="equation-stage">
            <span class="atom log-box">log<span class="base">a</span></span>
            <span class="atom">(</span>
            <span class="atom cargo">x</span>
            <span class="atom trigger" id="trigger1" onclick="activateMod1()" style="vertical-align: super; font-size: 1.4rem; margin-left:-5px;">2</span>
            <span class="atom">)</span>
        </div>
        <div class="explanation">
            <strong>Situation:</strong> Im Logarithmus steht eine Hochzahl ($x^2$).<br>
            <strong>Aktion:</strong> Klicke die rote 2. Sie springt nach vorne. Aus "Hoch 2" wird "Mal 2".
        </div>
    </div>

    <div class="module" id="mod2">
        <div class="module-header">
            <span>REGEL 2: Platzmangel (Produktregel)</span>
            <button class="reset-btn" onclick="resetMod2()">Nochmal</button>
        </div>
        <div class="equation-stage">
            <span class="atom log-box">log<span class="base">a</span></span>
            <span class="atom">(</span>
            <span class="atom cargo">x</span>
            <span class="atom trigger" id="trigger2" onclick="activateMod2()" style="margin: 0 5px;">‚Ä¢</span>
            <span class="atom cargo">y</span>
            <span class="atom">)</span>
        </div>
        <div class="explanation">
            <strong>Situation:</strong> Im Logarithmus wird multipliziert ($x \cdot y$).<br>
            <strong>Aktion:</strong> Klicke den Punkt. Der Logarithmus platzt auseinander. Aus "Mal" wird "Plus".
        </div>
    </div>

    <div class="module" id="mod3">
        <div class="module-header">
            <span>REGEL 3: Der Keller (Quotientenregel)</span>
            <button class="reset-btn" onclick="resetMod3()">Nochmal</button>
        </div>
        <div class="equation-stage">
            <span class="atom log-box">log<span class="base">a</span></span>
            <div style="display:inline-flex; flex-direction:column; align-items:center; margin: 0 10px; vertical-align:middle;">
                <span class="atom cargo">x</span>
                <span class="atom trigger" id="trigger3" onclick="activateMod3()" style="width: 40px; height: 4px; border:none; background:var(--c-danger); margin: 2px 0;"></span>
                <span class="atom cargo" id="y-val">y</span>
            </div>
        </div>
        <div class="explanation">
            <strong>Situation:</strong> Ein Bruch ($x$ geteilt durch $y$).<br>
            <strong>Aktion:</strong> Klicke den Bruchstrich. Das $y$ kommt hoch, muss aber ein "Minus" akzeptieren.
        </div>
    </div>

    <div class="module" id="mod4" style="border-left-color: var(--c-base);">
        <div class="module-header">
            <span>REGEL 4: Die Zwillinge (Basis Match)</span>
            <button class="reset-btn" onclick="resetMod4()">Nochmal</button>
        </div>
        <div class="equation-stage">
            <span class="atom log-box" id="log2-atom">log<span class="base">2</span></span>
            <span class="atom">(</span>
            <span class="atom trigger" id="base-match-trigger" onclick="activateMod4()" style="font-weight:bold; color:var(--c-base);">2</span>
            <span class="atom cargo" id="power-x" style="vertical-align: super; font-size: 1.4rem;">x</span>
            <span class="atom">)</span>
        </div>
        <div class="explanation">
            <strong>Situation:</strong> Basis (2) und Zahl (2) sind gleich.<br>
            <strong>Aktion:</strong> Klicke die rote 2. Sie fressen sich auf. Nur $x$ bleibt.
        </div>
    </div>

    <div class="module" id="mod5" style="border-left-color: #2D3748;">
        <div class="module-header">
            <span>REGEL 5: Todfeinde (ln und e)</span>
            <button class="reset-btn" onclick="resetMod5()">Nochmal</button>
        </div>
        <div class="equation-stage">
            <span class="atom trigger" id="ln-atom" onclick="activateMod5()">ln</span>
            <span class="atom">(</span>
            <span class="atom base" id="e-atom" style="font-size: 1.8rem;">e</span>
            <span class="atom cargo" id="ln-x" style="vertical-align: super; font-size: 1.4rem;">x</span>
            <span class="atom">)</span>
        </div>
        <div class="explanation">
            <strong>Situation:</strong> $ln$ trifft auf $e$.<br>
            <strong>Aktion:</strong> Klicke "ln". Sie vernichten sich. Nur $x$ bleibt.
        </div>
    </div>

    <div class="module" id="mod6" style="border-left-color: var(--c-action);">
        <div class="module-header">
            <span>REGEL 6: Log von 1</span>
            <button class="reset-btn" onclick="resetMod6()">Nochmal</button>
        </div>
        <div class="equation-stage" id="stage6">
            <span class="atom log-box">log<span class="base">10</span></span>
            <span class="atom">(</span>
            <span class="atom trigger" id="one-trigger" onclick="activateMod6()">1</span>
            <span class="atom">)</span>
        </div>
        <div class="explanation">
            <strong>Situation:</strong> Logarithmus von 1.<br>
            <strong>Aktion:</strong> Klicke die 1. Ergebnis ist immer 0.
        </div>
    </div>

    <div class="module" id="mod7" style="border-left-color: #000;">
        <div class="module-header">
            <span>NEU: REGEL 7: Der Turm (Inverse Eigenschaft)</span>
            <button class="reset-btn" onclick="resetMod7()">Nochmal</button>
        </div>
        <div class="equation-stage">
            <div style="display:flex; align-items:flex-start;">
                <span class="atom base" id="tower-base" style="font-size: 3rem; margin-top: 20px; margin-right:5px;">a</span>
                <div style="display:flex; align-items:center; margin-bottom: 20px;">
                    <span class="atom trigger" id="tower-log" onclick="activateMod7()" style="font-size: 1.5rem;">log<sub style="color:var(--c-base)">a</sub></span>
                    <span class="atom cargo" id="tower-x" style="font-size: 1.5rem; margin-left:2px;">(x)</span>
                </div>
            </div>
        </div>
        <div class="explanation">
            <strong>Situation:</strong> Die Basis unten ($a$) und die Basis im Logarithmus oben ($log_a$) sind gleich.<br>
            <strong>Aktion:</strong> Klicke auf "log". Basis und Logarithmus l√∂schen sich aus. Das $x$ f√§llt runter auf den Boden.
        </div>
    </div>

    <div class="module" id="mod8" style="border-left-color: #805AD5;">
        <div class="module-header">
            <span>NEU: REGEL 8: Die Wurzel (Tarnkappe)</span>
            <button class="reset-btn" onclick="resetMod8()">Nochmal</button>
        </div>
        <div class="equation-stage" id="root-stage">
            <span class="atom log-box">log</span>
            <span class="atom">(</span>
            <span class="atom trigger" id="root-symbol" onclick="activateMod8()" style="font-size: 2.5rem; margin-right:-10px;">‚àö</span>
            <span class="atom cargo" style="border-top: 2px solid var(--c-danger); padding-top:5px;">x</span>
            <span class="atom">)</span>
        </div>
        <div class="explanation">
            <strong>Situation:</strong> Eine Wurzel $\sqrt{x}$. Das sieht b√∂se aus.<br>
            <strong>Aktion:</strong> Klicke die Wurzel. Sie verwandelt sich in den Exponenten $\frac{1}{2}$ (Rucksack). Danach gilt Regel 1!
        </div>
    </div>

    <div class="module" id="sandbox">
        <div class="module-header">
            <span>üß™ DEINE SANDBOX (JETZT NOCH SCHLAUER)</span>
            <button class="reset-btn" onclick="clearSandbox()">Leeren</button>
        </div>
        
        <div class="helper-chips">
            <span class="chip" onclick="setInput('a^(log_a(x))')">Der Turm</span>
            <span class="chip" onclick="setInput('log(sqrt(x))')">Die Wurzel</span>
            <span class="chip" onclick="setInput('log((x^3 * y) / sqrt(z))')">Alles drin (Screenshot)</span>
        </div>

        <div class="input-group">
            <input type="text" id="custom-input" placeholder="Tippe z.B. log(sqrt(x)) ...">
            <button class="action-btn" onclick="parseInput()">H√§ndchenmodus Starten üñêÔ∏è</button>
        </div>

        <div class="equation-stage" id="sandbox-stage">
            <span style="color:#A0AEC0; font-size:1.2rem;">Warte auf Eingabe...</span>
        </div>
        
        <div class="explanation" id="sandbox-text">
            Tippe oben eine Aufgabe ein. Jetzt auch mit <code>sqrt(x)</code> und T√ºrmen.
        </div>
    </div>


<script>
    // --- MODULE LOGIK ---

    function activateMod1() {
        const t = document.getElementById('trigger1');
        t.style.transform = "translate(-180px, 0px)"; t.style.color = "var(--c-action)"; t.style.borderColor = "transparent"; t.style.background = "transparent"; t.style.zIndex = "100";
        setTimeout(() => { document.querySelector('#mod1 .equation-stage').innerHTML = `<span class="atom success-text" style="font-size: 2.2rem; margin-right: 10px;">2 ‚Ä¢</span><span class="atom log-box">log<span class="base">a</span></span><span class="atom">(</span><span class="atom cargo">x</span><span class="atom">)</span>`; }, 300);
    }
    function resetMod1() {
        document.querySelector('#mod1 .equation-stage').innerHTML = `<span class="atom log-box">log<span class="base">a</span></span><span class="atom">(</span><span class="atom cargo">x</span><span class="atom trigger" id="trigger1" onclick="activateMod1()" style="vertical-align: super; font-size: 1.4rem; margin-left:-5px;">2</span><span class="atom">)</span>`;
    }

    function activateMod2() {
        document.querySelector('#mod2 .equation-stage').innerHTML = `<span class="atom log-box">log<span class="base">a</span></span><span class="atom cargo">(x)</span><span class="atom success-text" style="font-size:3rem; margin:0 15px; animation:popIn 0.5s;">+</span><span class="atom log-box" style="animation:popIn 0.5s;">log<span class="base">a</span></span><span class="atom cargo">(y)</span>`;
    }
    function resetMod2() {
        document.querySelector('#mod2 .equation-stage').innerHTML = `<span class="atom log-box">log<span class="base">a</span></span><span class="atom">(</span><span class="atom cargo">x</span><span class="atom trigger" id="trigger2" onclick="activateMod2()" style="margin: 0 5px;">‚Ä¢</span><span class="atom cargo">y</span><span class="atom">)</span>`;
    }

    function activateMod3() {
        document.querySelector('#mod3 .equation-stage').innerHTML = `<span class="atom log-box">log<span class="base">a</span></span><span class="atom cargo">(x)</span><span class="atom success-text" style="font-size:3rem; margin:0 15px; animation:popIn 0.5s;">-</span><span class="atom log-box" style="animation:popIn 0.5s;">log<span class="base">a</span></span><span class="atom cargo">(y)</span>`;
    }
    function resetMod3() {
        document.querySelector('#mod3 .equation-stage').innerHTML = `<span class="atom log-box">log<span class="base">a</span></span><div style="display:inline-flex; flex-direction:column; align-items:center; margin: 0 10px; vertical-align:middle;"><span class="atom cargo">x</span><span class="atom trigger" id="trigger3" onclick="activateMod3()" style="width: 40px; height: 4px; border:none; background:var(--c-danger); margin: 2px 0;"></span><span class="atom cargo" id="y-val">y</span></div>`;
    }

    function activateMod4() {
        const logPart = document.getElementById('log2-atom');
        const trigger = document.getElementById('base-match-trigger');
        const x = document.getElementById('power-x');
        logPart.classList.add('vanish'); trigger.classList.add('vanish');
        setTimeout(() => { x.style.transform = "translate(-60px, 30px) scale(2)"; x.style.color = "var(--c-action)"; x.style.verticalAlign = "middle"; x.innerText = "x"; }, 200);
    }
    function resetMod4() {
        const logPart = document.getElementById('log2-atom'); const trigger = document.getElementById('base-match-trigger'); const x = document.getElementById('power-x');
        logPart.classList.remove('vanish'); trigger.classList.remove('vanish');
        x.style = "vertical-align: super; font-size: 1.4rem;"; x.innerText = "x"; x.style.color = "var(--c-cargo)";
    }

    function activateMod5() { 
        document.getElementById('ln-atom').classList.add('vanish');
        document.getElementById('e-atom').classList.add('vanish');
        setTimeout(() => { 
            const x = document.getElementById('ln-x');
            x.style.transform = "translate(-40px, 30px) scale(2)"; x.style.color = "var(--c-action)"; x.style.verticalAlign = "middle"; 
        }, 200);
    }
    function resetMod5() {
        document.querySelector('#mod5 .equation-stage').innerHTML = `<span class="atom trigger" id="ln-atom" onclick="activateMod5()">ln</span><span class="atom">(</span><span class="atom base" id="e-atom" style="font-size: 1.8rem;">e</span><span class="atom cargo" id="ln-x" style="vertical-align: super; font-size: 1.4rem;">x</span><span class="atom">)</span>`;
    }

    function activateMod6() { document.getElementById('stage6').innerHTML = `<span style="font-size:4rem; color:var(--c-action); animation:popIn 0.5s;">0</span>`; }
    function resetMod6() { document.querySelector('#mod6 .equation-stage').innerHTML = `<span class="atom log-box">log<span class="base">10</span></span><span class="atom">(</span><span class="atom trigger" id="one-trigger" onclick="activateMod6()">1</span><span class="atom">)</span>`; }

    function activateMod7() {
        document.getElementById('tower-base').classList.add('vanish');
        document.getElementById('tower-log').classList.add('vanish');
        setTimeout(() => {
            const x = document.getElementById('tower-x');
            x.style.transform = "translate(-30px, 30px) scale(2)"; x.style.color = "var(--c-action)"; x.innerText = "x";
        }, 300);
    }
    function resetMod7() {
        document.querySelector('#mod7 .equation-stage').innerHTML = `<div style="display:flex; align-items:flex-start;"><span class="atom base" id="tower-base" style="font-size: 3rem; margin-top: 20px; margin-right:5px;">a</span><div style="display:flex; align-items:center; margin-bottom: 20px;"><span class="atom trigger" id="tower-log" onclick="activateMod7()" style="font-size: 1.5rem;">log<sub style="color:var(--c-base)">a</sub></span><span class="atom cargo" id="tower-x" style="font-size: 1.5rem; margin-left:2px;">(x)</span></div></div>`;
    }

    function activateMod8() {
        document.getElementById('root-stage').innerHTML = `<span class="atom log-box">log</span><span class="atom">(</span><span class="atom cargo">x</span><span class="atom success-text" style="vertical-align: super; font-size: 1.4rem; animation:popIn 0.5s;">1/2</span><span class="atom">)</span>`;
    }
    function resetMod8() {
        document.getElementById('root-stage').innerHTML = `<span class="atom log-box">log</span><span class="atom">(</span><span class="atom trigger" id="root-symbol" onclick="activateMod8()" style="font-size: 2.5rem; margin-right:-10px;">‚àö</span><span class="atom cargo" style="border-top: 2px solid var(--c-danger); padding-top:5px;">x</span><span class="atom">)</span>`;
    }


    // =================================================================
    // SANDBOX ENGINE V3 (REPAIRED)
    // =================================================================
    
    function setInput(val) {
        document.getElementById('custom-input').value = val;
    }

    function clearSandbox() {
        document.getElementById('custom-input').value = "";
        document.getElementById('sandbox-stage').innerHTML = `<span style="color:#A0AEC0;">Warte auf Eingabe...</span>`;
        document.getElementById('sandbox-text').innerText = "Tippe oben eine Aufgabe ein.";
    }

    function parseInput() {
        let raw = document.getElementById('custom-input').value;
        if(!raw) return;
        raw = raw.replace(/\s/g, ''); 
        raw = raw.replace(/log_[a-z0-9]+/g, 'log');
        raw = raw.replace(/wurzel/g, 'sqrt');
        renderExpression(raw);
    }

    function renderExpression(expr) {
        const stage = document.getElementById('sandbox-stage');
        const info = document.getElementById('sandbox-text');

        if (!expr) return;

        // 1. CHECK: TURM
        const powIndex = findSplitIndex(expr, '^');
        if (powIndex !== -1 && (expr.includes('log') || expr.includes('ln'))) {
            const base = expr.substring(0, powIndex);
            let exponent = expr.substring(powIndex + 1);
            if(exponent.startsWith('(') && exponent.endsWith(')')) { exponent = exponent.slice(1, -1); }

            stage.innerHTML = `
                <div style="display:flex; align-items:flex-start;">
                    <span class="atom base" style="font-size: 3rem; margin-top: 20px;">${base}</span>
                    <div style="border: 2px dashed var(--c-danger); padding:10px; border-radius:10px; background:rgba(229,62,62,0.05); margin-left:5px;">
                        <div style="font-size:0.7rem; color:var(--c-danger); margin-bottom:5px; font-weight:bold;">DACHGESCHOSS</div>
                        <span class="atom trigger" onclick="solveTower('${exponent}')" style="font-size: 1.2rem;">${exponent}</span>
                    </div>
                </div>
            `;
            info.innerHTML = "<strong>Der Turm!</strong> (Regel 7). Klicke auf das Dachgeschoss.";
            return;
        }

        // 2. CHECK: SUMME/DIFFERENZ
        const plusIndex = findSplitIndex(expr, '+');
        if (plusIndex !== -1) {
            const partA = expr.substring(0, plusIndex);
            const partB = expr.substring(plusIndex + 1);
            stage.innerHTML = `<span class="atom">${partA}</span><span class="atom trigger" onclick="transformSum('${partA}','${partB}')" style="font-size:2rem; color:var(--c-danger); margin:0 10px;">+</span><span class="atom">${partB}</span>`;
            info.innerHTML = "Summe gefunden. Zusammenfassen?";
            return;
        }

        // 3. CHECK: PRODUKT (Faktor vor Log)
        const multIndex = findSplitIndex(expr, '*');
        if (multIndex !== -1) {
            const partA = expr.substring(0, multIndex);
            const partB = expr.substring(multIndex + 1);
            if (partB.startsWith('log') || partB.startsWith('ln')) {
                 const inner = extractInner(partB);
                 stage.innerHTML = `<span class="atom trigger" onclick="transformRucksack('${partA}', '${inner}')" style="font-size: 1.5rem; color:var(--c-danger); margin-right:5px;">${partA} ‚Ä¢</span><span class="atom log-box">log</span>(<span class="atom cargo">${inner}</span>)`;
                 info.innerHTML = "Faktor vor Log gefunden. Rucksack packen?";
                 return;
            }
        }

        // 4. CHECK: IST ES EIN LOG?
        if (expr.startsWith('log') || expr.startsWith('ln')) {
            const inner = extractInner(expr);
            
            // WURZEL?
            if (inner.includes('sqrt')) {
                const content = getInnerContent(inner, 'sqrt');
                stage.innerHTML = `<span class="atom log-box">log</span>(<span class="atom trigger" onclick="transformSqrt('${content}')" style="font-size: 2.5rem; margin-right:-5px;">‚àö</span><span class="atom cargo" style="border-top: 2px solid var(--c-danger); padding-top:5px;">${content}</span>)`;
                info.innerHTML = "Wurzel entdeckt! Wegklicken.";
                return;
            }

            // BRUCH?
            const divIndex = findSplitIndex(inner, '/');
            if (divIndex !== -1) {
                const num = inner.substring(0, divIndex);
                const den = inner.substring(divIndex + 1);
                const cleanNum = stripOuterBrackets(num);
                const cleanDen = stripOuterBrackets(den);
                stage.innerHTML = `<div style="text-align:center;"><div style="margin-bottom:10px;"><span class="atom log-box">log</span><div style="display:inline-flex; flex-direction:column; align-items:center; margin: 0 10px; vertical-align:middle;"><span class="atom cargo">${cleanNum}</span><span class="atom trigger" onclick="transformDivide('${cleanNum}', '${cleanDen}')" style="width: 100%; height: 4px; border:none; background:var(--c-danger); margin: 2px 0;"></span><span class="atom cargo">${cleanDen}</span></div></div></div>`;
                info.innerHTML = "Bruch im Log! Zerlegen.";
                return;
            }

            // PRODUKT?
            const innerMultIndex = findSplitIndex(inner, '*');
            if (innerMultIndex !== -1) {
                const a = inner.substring(0, innerMultIndex);
                const b = inner.substring(innerMultIndex + 1);
                stage.innerHTML = `<span class="atom log-box">log</span>(<span class="atom cargo">${a}</span><span class="atom trigger" onclick="transformMultiply('${a}', '${b}')" style="margin:0 5px;">‚Ä¢</span><span class="atom cargo">${b}</span>)`;
                info.innerHTML = "Produkt im Log! Trennen.";
                return;
            }

            // POTENZ?
            const innerPowIndex = findSplitIndex(inner, '^');
            if (innerPowIndex !== -1) {
                const base = inner.substring(0, innerPowIndex);
                const exp = inner.substring(innerPowIndex + 1);
                stage.innerHTML = `<span class="atom log-box">log</span>(<span class="atom cargo">${base}</span><span class="atom trigger" id="sand-exp" onclick="transformPower('${base}', '${exp}')" style="vertical-align: super; font-size: 1.2rem;">${exp}</span>)`;
                info.innerHTML = "Exponent im Log! Rucksack werfen.";
                return;
            }
        }

        stage.innerHTML = `<span style="font-family:monospace; font-size:1.5rem;">${expr}</span>`;
        info.innerHTML = "Keine Regel anwenden. Versuch, Klammern zu setzen!";
    }

    // --- HELPER ---
    function findSplitIndex(str, char) {
        let depth = 0;
        // Speziell f√ºr log/ln: Wenn wir IM log sind, ignorieren wir den Wrapper
        let startIdx = 0;
        if ((str.startsWith('log(') || str.startsWith('ln(')) && str.endsWith(')')) {
             return -1; // Wir wollen nicht im Log splitten wenn wir au√üen sind
        }

        for (let i = 0; i < str.length; i++) {
            if (str[i] === '(') depth++;
            else if (str[i] === ')') depth--;
            else if (depth === 0 && str[i] === char) return i;
        }
        return -1;
    }

    function stripOuterBrackets(str) {
        if(str.startsWith('(') && str.endsWith(')')) {
            // Check if valid pair
            let depth = 0;
            let valid = true;
            for(let i=0; i<str.length-1; i++) {
                if(str[i] === '(') depth++;
                if(str[i] === ')') depth--;
                if(depth === 0) valid = false; // Klammer ging zu fr√ºh zu
            }
            if(valid) return str.slice(1,-1);
        }
        return str;
    }

    function extractInner(str) {
        if (str.includes('(')) {
            let start = str.indexOf('(');
            let end = str.lastIndexOf(')');
            return str.substring(start+1, end);
        }
        return str;
    }

    function getInnerContent(str, funcName) {
        let start = str.indexOf(funcName) + funcName.length + 1; 
        let depth = 1;
        let end = start;
        while (depth > 0 && end < str.length) {
            if (str[end] === '(') depth++;
            if (str[end] === ')') depth--;
            end++;
        }
        return str.substring(start, end-1);
    }

    // --- BUTTON ACTIONS ---
    function continueWith(newExpr) {
        document.getElementById('custom-input').value = newExpr;
        parseInput();
    }

    function transformDivide(num, den) {
        const stage = document.getElementById('sandbox-stage');
        stage.innerHTML = `<div style="text-align:center;"><div style="margin-bottom:15px; font-size:1.8rem;"><span class="atom log-box">log</span>(${num}) <span class="success-text">-</span> <span class="atom log-box">log</span>(${den})</div><div style="display:flex; gap:10px; justify-content:center;"><button class="action-btn" onclick="continueWith('log(${num})')">Links weiter</button><button class="action-btn" onclick="continueWith('log(${den})')">Rechts weiter</button></div></div>`;
        document.getElementById('sandbox-text').innerHTML = "Zerlegt!";
    }

    function transformMultiply(a, b) {
        const stage = document.getElementById('sandbox-stage');
        stage.innerHTML = `<div style="text-align:center;"><div style="margin-bottom:15px; font-size:1.8rem;"><span class="atom log-box">log</span>(${a}) <span class="success-text">+</span> <span class="atom log-box">log</span>(${b})</div><div style="display:flex; gap:10px; justify-content:center;"><button class="action-btn" onclick="continueWith('log(${a})')">Links weiter</button><button class="action-btn" onclick="continueWith('log(${b})')">Rechts weiter</button></div></div>`;
        document.getElementById('sandbox-text').innerHTML = "Getrennt!";
    }

    function transformPower(base, exp) {
        const stage = document.getElementById('sandbox-stage');
        const t = document.getElementById('sand-exp'); if(t) { t.style.transform = "translate(-100px, 0px)"; t.style.color = "var(--c-action)"; }
        setTimeout(() => {
            stage.innerHTML = `<div style="text-align:center;"><div style="margin-bottom:15px; font-size:1.8rem;"><span class="success-text">${exp} ‚Ä¢ </span><span class="atom log-box">log</span>(${base})</div><button class="action-btn" onclick="continueWith('log(${base})')">Rest zerlegen?</button></div>`;
            document.getElementById('sandbox-text').innerHTML = "Rucksack unten!";
        }, 300);
    }

    function transformSqrt(content) {
        const stage = document.getElementById('sandbox-stage');
        stage.innerHTML = `<div style="text-align:center;"><div style="margin-bottom:15px; font-size:1.8rem;"><span class="atom log-box">log</span>(<span class="atom cargo">${content}</span><span class="success-text" style="vertical-align:super; font-size:1rem;">1/2</span>)</div><button class="action-btn" onclick="continueWith('log(${content}^(1/2))')">Jetzt Rucksack werfen</button></div>`;
        document.getElementById('sandbox-text').innerHTML = "Wurzel ist 1/2!";
    }

    function transformRucksack(factor, content) {
        const stage = document.getElementById('sandbox-stage');
        stage.innerHTML = `<span class="atom log-box">log</span>(<span class="atom cargo">${content}</span><span class="atom success-text" style="vertical-align:super; font-size:1.2rem; animation:popIn 0.5s;">${factor}</span>)`;
        document.getElementById('sandbox-text').innerHTML = "Verstaut!";
    }

    function transformSum(a, b) {
        const innerA = extractInner(a) || a;
        const innerB = extractInner(b) || b;
        const stage = document.getElementById('sandbox-stage');
        stage.innerHTML = `<div style="font-size:1.8rem; color:var(--c-action);"><span class="atom log-box">log</span>(${innerA} ‚Ä¢ ${innerB})</div>`;
        document.getElementById('sandbox-text').innerHTML = "Zusammengefasst!";
    }

    function solveTower(exponent) {
        const stage = document.getElementById('sandbox-stage');
        if (exponent.includes('+') || exponent.includes('-') || exponent.includes('/')) {
             stage.innerHTML = `<div style="color:var(--c-danger); font-size:1.5rem; text-align:center;">Halt! Das Dachgeschoss ist unordentlich!<br><code>${exponent}</code><br>Tippe das erst oben ein und r√§um es auf!</div>`;
        } else {
            let content = extractInner(exponent) || exponent.replace('log', '');
            stage.innerHTML = `<div style="font-size:3rem; color:var(--c-action); animation:popIn 0.5s;">${content}</div>`;
            document.getElementById('sandbox-text').innerHTML = "B√ÑM! Gel√∂st.";
        }
    }

    const styleSheet = document.createElement("style");
    styleSheet.innerText = `
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 80% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); } }
    `;
    document.head.appendChild(styleSheet);

</script>
</body>
</html>
